<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.quantom.audition.dao.ApplymentDao">

	<select id="getForPrintApplyments" resultMap="applyment">

		SELECT AM.*,
		M.nickname AS extra__writer,
		M.age AS extra__age,
		M.gender
		AS extra__gender,
		M.name AS extra__writerRealName,
		M.cellphoneNo AS
		extra__writerCellphoneNo,
		M.email AS extra__writerEmail,
		M.nickname AS
		extra__writer
		FROM applyment AS AM
		INNER JOIN member AS M
		ON AM.memberId
		= M.id
		WHERE AM.relId = #{relId}
		AND AM.relTypeCode = #{relTypeCode}
		AND
		AM.displayStatus = 1
		AND AM.id <![CDATA[ >= ]]>
		#{from}
		<if test="memberId != null">AND AM.memberId = #{memberId}</if>
		ORDER BY AM.id ASC
	</select>

	<select id="getForPrintApplymentRelatedToResult"
		resultMap="applyment">
		SELECT AM.*,
		M.nickname AS extra__writer,
		M.age AS extra__age,
		M.gender
		AS extra__gender,
		M.name AS extra__writerRealName,
		M.cellphoneNo AS
		extra__writerCellphoneNo,
		M.email AS
		extra__writerEmail,
		M.nickname AS
		extra__writer
		FROM applyment AS AM
		INNER JOIN member AS M
		ON AM.memberId
		= M.id
		WHERE AM.displayStatus = 1
		AND AM.id =
		#{id}
		AND AM.result = #{result}
		ORDER BY AM.id ASC
	</select>

	<select id="getForPrintApplyment" resultMap="applyment">
		SELECT AM.*,
		M.nickname AS extra__writer,
		M.age AS extra__age,
		M.gender AS
		extra__gender,
		M.name AS extra__writerRealName,
		M.cellphoneNo AS
		extra__writerCellphoneNo,
		M.email AS extra__writerEmail,
		M.nickname AS
		extra__writer
		FROM applyment AS AM
		INNER JOIN member AS M
		ON AM.memberId
		= M.id
		WHERE AM.displayStatus = 1
		AND AM.id = #{id}
	</select>

	<select id="getForPrintApplymentsByRelIdAndRelTypeCode"
		resultMap="applymentForAudition">
		SELECT AP.*,
		M.id AS member__id,
		M.name AS member__name,
		M.age AS member__age,
		M.gender AS member__gender,
		M.recommendation AS member__recommendation,
		MF.id AS file__member__Id,
		MF.updateDate AS file__member__updateDate,
		MF.relTypeCode AS file__member__relTypeCode,
		MF.fileExt AS file__member__fileExt,
		MF.fileDir AS file__member__fileDir,
		AF.id AS file__applyment__id,
		AF.updateDate AS file__applyment__updateDate,
		AF.relTypeCode AS file__applyment__relTypeCode,
		AF.fileExt AS file__applyment__fileExt,
		AF.fileDir AS file__applyment__fileDir
		FROM applyment AS AP
		LEFT OUTER
		JOIN member AS M
		ON M.Id = AP.memberId
		LEFT OUTER
		JOIN file AS MF
		ON MF.relId = M.id
		AND MF.relTypeCode = "member"
		LEFT OUTER
		JOIN file AS AF
		ON AF.relTypeCode = "applyment"
		AND AF.relId = AP.id
		WHERE AP.relTypeCode = #{relTypeCode}
		AND AP.relId = #{relId}
		AND AP.Result = 0
	</select>

	<select id="getForPrintApplymentsByResult"
		resultMap="applymentAndRecommendatin">
		SELECT
		AM.*,
		M.nickname AS extra__writer,
		M.age AS extra__age,
		M.gender AS
		extra__gender,
		M.name AS extra__writerRealName,
		M.cellphoneNo AS
		extra__writerCellphoneNo,
		M.email AS
		extra__writerEmail,
		M.nickname AS
		extra__writer,
		M.recommendation AS
		extra__writerRecommendation
		FROM
		applyment AS AM
		INNER JOIN member AS M
		ON AM.memberId
		= M.id
		WHERE
		AM.displayStatus = 1
		AND AM.relId = #{relId}
		AND AM.relTypeCode =
		#{relTypeCode}
		AND AM.id <![CDATA[ >= ]]>
		#{from}
		AND AM.result = 0
	</select>

	<insert id="writeApplyment" useGeneratedKeys="true"
		keyProperty="id">
		INSERT INTO applyment
		SET regDate = NOW(),
		updateDate =
		NOW(),
		memberId = #{memberId},
		relTypeCode =
		#{relTypeCode},
		relId =
		#{relId},
		displayStatus
		= 1
	</insert>

	<select id="getForPrintApplymentById" resultMap="applyment">
		SELECT AM.*,
		M.nickname AS extra__writer,
		M.name AS extra__writerRealName,
		M.cellphoneNo AS extra__writerCellphoneNo,
		M.email AS
		extra__writerEmail,
		M.nickname AS extra__writer
		FROM applyment AS
		AM
		INNER JOIN member AS M
		ON
		AM.memberId = M.id
		WHERE AM.id = #{id}
		AND
		AM.displayStatus = 1
		AND AM.id
		= #{id}
	</select>

	<select id="getApplymentsByRelId" resultMap="applyment">
		SELECT *
		FROM
		applyment AS AM
		WHERE AM.relId = #{relId}
		AND AM.relTypeCode =
		#{relTypeCode}
		AND AM.delStatus = 0
		ORDER BY AM.id DESC
	</select>

	<select id="getApplymentByRelIdAndMemberId"
		resultMap="applyment">
		SELECT *
		FROM applyment AS AM
		WHERE AM.relId = #{relId}
		AND
		AM.relTypeCode = #{relTypeCode}
		AND AM.memberId = #{memberId}
		AND
		AM.delStatus = 0
	</select>

	<select id="getApplymenResultInfoByMemberId"
		resultMap="applymentResult">
		SELECT Apply.*,
		Act.name AS
		extra__actingName,
		Act.job AS
		extra__actingJob,
		Act.gender AS
		extra__actingGender,
		Act.StartDate AS
		extra__actingStartDate,
		Act.EndDate AS
		extra__actingEndDate,
		Art.name AS
		extra__artworkName,
		Art.productionName
		AS extra__ProductionName,
		Art.directorName AS extra__directorName,
		ARTF.id AS
		artwork__id,
		ARTF.updateDate AS artwork__updateDate,
		ARTF.relTypeCode
		AS
		artwork__relTypeCode,
		ARTF.fileExt AS
		artwork__fileExt,
		ARTF.typeCode AS
		artwork__typeCode,
		ARTF.fileDir AS artwork__fileDir
		FROM
		applyment AS
		Apply
		LEFT OUTER
		JOIN `actingRole` AS Act
		ON
		Apply.relId = Act.id
		LEFT
		OUTER JOIN
		`artwork` AS Art
		ON Act.artworkId
		= Art.id
		LEFT OUTER JOIN
		`file` AS ARTF
		ON ARTF.relId = Art.id
		AND ARTF.relTypeCode = "artwork"
		WHERE Apply.MemberId =
		#{memberId}
	</select>

	<update id="deleteApplyment">
		UPDATE applyment
		SET delStatus = 1,
		delDate = NOW(),
		displayStatus = 0
		WHERE id = #{id}
	</update>

	<update id="modifyApplyment">
		UPDATE applyment
		<set>
			updateDate = NOW(),
		</set>
		WHERE id = #{id}
	</update>

	<update id="changeHideStatus">
		UPDATE applyment
		<set>
			hideStatus = #{hideStatus}
		</set>
		WHERE id = #{id}
	</update>

	<update id="changeApplymentResult">
		UPDATE applyment
		<set>
			updateDate = NOW(),
			result = #{result}
		</set>
		WHERE id = #{id}
	</update>

	<resultMap type="Applyment" id="applyment">
		<id property="id" column="id" />
		<id property="regDate" column="regDate" />
		<id property="updateDate" column="updateDate" />
		<id property="delDate" column="delDate" />
		<id property="delStatus" column="delStatus" />
		<id property="displayStatus" column="displayStatus" />
		<id property="hideStatus" column="hideStatus" />
		<id property="memberId" column="memberId" />
		<id property="relId" column="relId" />
		<id property="result" column="result" />
		<id property="relTypeCode" column="relTypeCode" />
	</resultMap>

	<resultMap type="Applyment" id="applymentAndRecommendatin"
		extends="applyment">
		<association property="extra" javaType="map">
			<id property="writer" column="extra__writer" />
			<id property="writerAge" column="extra__age" />
			<id property="writerGender" column="extra__gender" />
			<id property="writerCellphoneNo" column="extra__writerCellphoneNo" />
			<id property="writerEmail" column="extra__writerEmail" />
			<id property="writerRealName" column="extra__writerRealName" />
			<id property="writerRecommendation"
				column="extra__writerRecommendation" />
		</association>
	</resultMap>

	<resultMap type="Applyment" id="applymentResult"
		extends="applyment">
		<association property="extra" javaType="map">
			<id property="actingName" column="extra__actingName" />
			<id property="actingJob" column="extra__actingJob" />
			<id property="actingGender" column="extra__actingGender" />
			<id property="actingStartDate" column="extra__actingStartDate" />
			<id property="actingEndDate" column="extra__actingEndDate" />
			<id property="artworkName" column="extra__artworkName" />
			<id property="ProductionName" column="extra__ProductionName" />
			<id property="directorName" column="extra__directorName" />
		</association>
		<collection property="files" resultMap="files"
			ofType="File" columnPrefix="artwork__" />
	</resultMap>

	<resultMap type="Applyment" id="applymentForAudition"
		extends="applyment">
		<association property="extra" javaType="map">
			<id property="memberId" column="member__id" />
			<id property="memberName" column="member__name" />
			<id property="memberAge" column="member__age" />
			<id property="memberGender" column="member__gender" />
			<id property="memberRecommendation" column="member__recommendation" />
			<id property="fileIdForMember" column="file__member__id" />
			<id property="fileUpdateDateForMember"
				column="file__member__updateDate" />
			<id property="fileRelTypeCodeForMember"
				column="file__member__relTypeCode" />
			<id property="fileExtForMember" column="file__member__fileExt" />
			<id property="fileDirForMember" column="file__member__fileDir" />
			<id property="fileIdForApplyment" column="file__applyment__id" />
			<id property="fileUpdateDateForApplyment"
				column="file__applyment__updateDate" />
			<id property="fileRelTypeCodeForApplyment"
				column="file__applyment__relTypeCode" />
			<id property="fileExtForApplyment" column="file__applyment__fileExt" />
			<id property="fileDirForApplyment" column="file__applyment__fileDir" />
		</association>
	</resultMap>

	<resultMap id="files" type="File">
		<id property="id" column="id" />
		<id property="updateDate" column="updateDate" />
		<id property="relTypeCode" column="relTypeCode" />
		<id property="typeCode" column="typeCode" />
		<id property="fileExt" column="fileExt" />
		<id property="fileDir" column="fileDir" />
	</resultMap>
</mapper>